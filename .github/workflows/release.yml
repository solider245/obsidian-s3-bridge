name: è‡ªåŠ¨å‘å¸ƒ Obsidian æ’ä»¶

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œæµ‹è¯• (ç¡®ä¿åŸºæœ¬åŠŸèƒ½æ­£å¸¸)
        run: npm run test

      - name: æ„å»ºæ’ä»¶ (ç¡®ä¿ç¼–è¯‘æˆåŠŸ)
        run: npm run build

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "PLUGIN_NAME=obsidian-s3-bridge" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå‘å¸ƒç›®å½•
        run: mkdir -p release

      - name: å¤åˆ¶å‘å¸ƒæ–‡ä»¶
        run: |
          cp main.js release/
          cp manifest.json release/
          cp styles.css release/

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          cd release
          zip -r "obsidian-s3-bridge-v${{ steps.version.outputs.version }}.zip" main.js manifest.json styles.css

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: obsidian-s3-bridge-plugin
          path: |
            release/main.js
            release/manifest.json
            release/styles.css
            release/obsidian-s3-bridge-v*.zip

  create-release:
    needs: build-and-package
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: obsidian-s3-bridge-plugin
          path: release

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "PLUGIN_NAME=obsidian-s3-bridge" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´æ—¥å¿—
          if [ -f "CHANGELOG.md" ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
            NOTES=$(awk "/## \\[${{ steps.version.outputs.version }}\\]/,/^## /" CHANGELOG.md | sed '$d' | sed '1d')
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "$NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## ç‰ˆæœ¬ ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ä¸»è¦æ”¹è¿›" >> $GITHUB_OUTPUT
            echo "- è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ" >> $GITHUB_OUTPUT
            echo "- ä»£ç è´¨é‡ä¼˜åŒ–" >> $GITHUB_OUTPUT
            echo "- å®‰å…¨æ£€æŸ¥å¢å¼º" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Obsidian S3-Bridge v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            release/main.js
            release/manifest.json
            release/styles.css
            release/obsidian-s3-bridge-v*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "å‘å¸ƒåŒ…: obsidian-s3-bridge-v${{ steps.version.outputs.version }}.zip"
          echo "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
