name: Release Obsidian Plugin

on:
  push:
    tags:
      - 'v*' # åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "NODE_OPTIONS=--max-old-space-size=4096" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Verify required files
        run: |
          [ -f "main.js" ] || { echo "âŒ main.js not found!"; exit 1; }
          [ -f "manifest.json" ] || { echo "âŒ manifest.json not found!"; exit 1; }
          [ -f "styles.css" ] || echo "/* Empty */" > styles.css
          echo "âœ… All required files verified!"

      - name: Create release package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_NAME="obsidian-s3-bridge-${VERSION}"
          mkdir -p $PACKAGE_NAME
          cp main.js manifest.json styles.css $PACKAGE_NAME/
          zip -r "${PACKAGE_NAME}.zip" $PACKAGE_NAME/
          echo "âœ… Release package created: ${PACKAGE_NAME}.zip"

      # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ›´å¥½çš„release actionï¼Œç¡®ä¿æ ‡è®°ä¸ºlatest
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Obsidian S3-Bridge ${{ github.ref_name }}
          artifacts: '*.zip,main.js,manifest.json,styles.css'
          makeLatest: true # è¿™ä¸ªå‚æ•°ç¡®ä¿æ ‡è®°ä¸ºlatest!
          generateReleaseNotes: true
          body: |
            ## Obsidian S3-Bridge ${{ github.ref_name }}

            ### What's Changed
            - Automatic release from GitHub Actions
            - Version: ${{ github.ref_name }}

            ### Files Included
            - `main.js` - Main plugin file
            - `manifest.json` - Plugin configuration
            - `styles.css` - Plugin styles

            ### Installation
            1. Download the zip file
            2. Extract to your Obsidian vault plugins folder
            3. Enable the plugin in Obsidian settings

            ---
            ğŸ¤– Generated by GitHub Actions
